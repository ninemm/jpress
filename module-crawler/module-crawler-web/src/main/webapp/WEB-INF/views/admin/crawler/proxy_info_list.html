#@layout()

#define css()
<link rel="stylesheet" href="#(CPATH)/static/components/bootstrap-table/bootstrap-table.css">
#end

#define script()
<script src="#(CPATH)/static/components/bootstrap-table/bootstrap-table.js"></script>
<script src="#(CPATH)/static/components/bootstrap-table/bootstrap-table-zh-CN.js"></script>
<script src="https://cdn.bootcss.com/dayjs/1.8.14/dayjs.min.js"></script>
<script>

    let $form = $('#form');
    let $table = $('#_proxy_table');
    let $selectedIds = new Array();
    let $selectedKeywords = new Array();

    function doDel(id) {
        ajaxGet("#(CPATH)/admin/crawler/proxyInfo/doDel/" + id);
    }

    $("#batchDel").click(function () {
        var ids = $selectedIds.join(',');
        if (ids == "") {
            showErrorMessage('您未选择任何条目');
            return
        }

        let options = {
            msg: '确定批量删除代理吗?'
            , ids: ids
            , okFunction: okBatchDelFun
        };

        showConfirm(options);
    });

    function okBatchDelFun(ids) {
        ajaxGet("#(CPATH)/crawler/proxyInfo/doBatchDel?ids=" + ids, doRefresh);
    }

    $("#batchVerify").click(function () {
        var ids = $selectedIds.join(',');
        if (ids == "") {
            showErrorMessage('您未选择任何条目');
            return
        }

        let options = {
            msg: '确定批量校验代理吗?'
            , ids: ids
            , okFunction: okBatchVerifyFun
        };

        showConfirm(options);
    });

    function okBatchVerifyFun(ids) {
        layer.msg('代理验证中(代理验证比较耗时),请稍后...', {
            icon: 16,
            offset: '120px',
            shade: 0.3
        });
        ajaxGet("#(CPATH)/admin/crawler/proxyInfo/doBatchVerify?ids=" + ids, okVerifyFunc);
    }

    var initParams = function (params) {

        var param = {
            size: params.limit,
            page: params.offset / params.limit + 1,
            protocol: $('#protocol').val(),
            response: $('#response').val(),
            isEnable: '#(isEnable ??)'
        };
        return param;
    };

    var initFields = function () {
        var fields =
            [
                {field: "checkbox", checkbox: true, class: 'dataItem',
                    formatter: function (i, row) {
                        // 每次加载 checkbox 时判断当前 row 的 id 是否已经存在全局Array里
                        if ($.inArray(row.id, $selectedIds) != -1) {
                            return { checked : true }
                        }
                    }
                },
                {field: "ip", title: "IP", width: '16%',
                    formatter: function (value, row, rowIndex) {
                        value = "<strong><a href='#'>" + value + "</a></strong>";
                        if (row.is_enable) {
                            value = '<small class="label label-success">有效</small> ' + value;
                        }
                        return value;
                    },
                    edit: false
                },
                {field: "port", title: "端口", align: "center", width: '5%', edit: false},
                {field: "anonymity_type", title: "匿名度", width: '5%', edit: false},
                {field: "protocol", title: "协议", width: '5%', edit: false},
                {field: "response", title: "响应速度(秒)", width: '5%', edit: false},
                {field: "location", title: "位置", align: "left",
                    formatter: function (value, row, rowIndex) {
                        if (row.isp) {
                            value += ' <span class="text-green">' + row.isp + '</span>';
                        }
                        return value;
                    },
                    edit: false
                },
                {field: "verify_time", title: "最后校验时间", align: "center", width: '15%',
                    formatter: function (value, row, rowIndex) {
                        return dayjs(value).format('YYYY-MM-DD HH:mm');
                    },
                    edit: false
                },
                {
                    field: "action", title: "操作", width: '12%',
                    formatter: function (value, row, rowIndex) {
                        var url = '#(CPATH)/admin/crawler/proxyInfo/edit/' + row.id;
                        var strHtml = '<a href="' + url + '" class="btn btn-xs text-green" title="编辑"><i class="fa fa-edit"></i></a> '
                            + '<a href="javascript:void(0);" class="btn btn-xs text-orange" title="校验" onclick="doVerify(\'' + row.id + '\')"><i class="fa fa-check-square"></i></a> '
                            + '<a href="javascript:void(0);" class="btn btn-xs text-red" title="删除" onclick="doDel(\'' + row.id + '\')"><i class="fa fa-trash"></i></a>';
                        return strHtml;
                    },
                    edit: false
                }
            ];
        return fields;
    }

    let options = {
        tableId: '#_proxy_table',
        url: '#(CPATH)/admin/crawler/proxyInfo/paginate',
        // toolbar: '#toolbars',
        fields: initFields(),
        queryParams: initParams
    };

    initEditTable(options);

    /** 初始化选中、取消事件 */
    $table.on('uncheck.bs.table check.bs.table check-all.bs.table uncheck-all.bs.table', function (e, rows) {
        // 点击时获取选中的行或取消选中的行
        let data = $.isArray(rows) ? rows : [rows];
        updateCheckedRows(e.type, data);
    });

    function updateCheckedRows(type, data) {
        if (type.indexOf('uncheck') == -1) {
            $.each(data, function (i, v) {
                // 添加时，判断一行或多行的 id 是否已经在数组里 不存则添加
                //$selectedKeywords.indexOf(v.title) == -1 ? $selectedKeywords.push(v.title) : -1;
                $selectedIds.indexOf(v.id) == -1 ? $selectedIds.push(v.id) : -1;
            });
        } else {
            $.each(data, function (i, v) {
                // 删除取消选中行
                //$selectedKeywords.splice($selectedKeywords.indexOf(v.title), 1);
                $selectedIds.splice($selectedIds.indexOf(v.id), 1);
            });
        }
    }

    function doVerify(id) {
        layer.msg('代理验证中...', {
            icon: 16,
            offset: '120px',
            shade: 0.3
        });
        ajaxGet("#(CPATH)/admin/crawler/proxyInfo/doVerify/" + id, okVerifyFunc);
    }

    function okVerifyFunc() {
        layer.close(layer.index);
        location.reload();
    }

    function doRefresh() {
        $table.bootstrapTable('refresh', options);
    }

</script>
#end

#define content()
<div class="content-wrapper">

    <section class="content-header">
        <h1>
            代理IP管理
            <small>Proxy IP Items</small>
        </h1>
    </section>

    <section class="content-header text-tap">
        <a href="#(CPATH)/admin/crawler/proxyInfo">全部 (#((enableCount + unableCount) ?? 0))</a>
        | <a href="?isEnable=1">有效 (#(enableCount ?? 0))</a>
        | <a href="?isEnable=0" style="color: #a00">无效 (#(unableCount ?? 0))</a>
        | <a href="?status=trash" style="color: #a00">已检查 (#(trashCount ?? 0))</a>
    </section>

    <section class="content">

        <div class="row">
            <div class="col-xs-12">
                <div class="box box-primary">
                    <div class="box-header with-border">
                        <div class="row">
                            <form class="form-horizontal" action="#(CPATH)/admin/crawler/proxyInfo">
                                <div class="col-xs-5">
                                    <a href="#(CPATH)/admin/proxy/proxyInfo/edit" class="btn btn-sm btn-primary ">
                                        <i class="fa fa-plus"></i> 新建
                                    </a>
                                    <a href="javascript:" id="batchVerify" class="btn btn-sm btn-warning">
                                        <i class="fa fa-check"></i> 校验
                                    </a>
                                    <button type="button" id="batchDel" class="btn btn-sm btn-default checkAction"> 批量删除</button>
                                </div>
                                <div class="col-xs-3">
                                    <label class="control-label col-xs-5">协议:</label>
                                    <div class="col-xs-7 input-xs">
                                        <select class="form-control" name="protocol" id="protocol">
                                            <option value="">--请选择--</option>
                                            #for(item : protocols)
                                            <option value="#(item.requestType)" #if(item.requestType == protocol)selected#end>#(item.requestType)</option>
                                            #end
                                        </select>
                                    </div>
                                </div>
                                <div class="col-xs-3">
                                    <label class="control-label col-xs-5">响应速度:</label>
                                    <div class="col-xs-7 input-xs">
                                        <input class="form-control" type="search" name="response" id="response" value="#(response ??)" placeholder="请输入...">
                                    </div>
                                </div>
                                <div class="col-sm-1">
                                    <button type="submit" id="search" class="btn btn-sm btn-primary"><i class="fa fa-search"></i> 搜索</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <!-- /.box-header -->
                    <div class="box-body ">
                        <table class="table table-striped table-hover table-condensed" id="_proxy_table"></table>
                    </div>
                </div>
                <!-- /.box -->
            </div>
        </div>

    </section>
</div>

<!--<div id="toolbars">
    <form class="form-inline" action="#(CPATH)/admin/crawler/proxyInfo">
        <a href="#(CPATH)/admin/proxy/proxyInfo/edit" class="btn btn-sm btn-primary ">
            <i class="fa fa-plus"></i> 新建
        </a>
        <a href="javascript:" id="batchVerify" class="btn btn-sm btn-warning">
            <i class="fa fa-check"></i> 校验
        </a>
        <button type="button" id="batchDel" class="btn btn-sm btn-default checkAction"> 批量删除</button>
        <div class="form-group">
            <label for="protocol">协议:</label>
            <select class="form-control input-sm" name="protocol" id="protocol">
                <option value="">&#45;&#45;请选择&#45;&#45;</option>
                #for(item : protocols)
                <option value="#(item.requestType)" #if(item.requestType == protocol)selected#end>#(item.requestType)</option>
                #end
            </select>
        </div>
        <div class="form-group">
            <label for="response">响应速度:</label>
            <input class="form-control input-sm" type="search" name="response" id="response" value="#(response ??)" placeholder="请输入...">
        </div>
        <button type="submit" id="search" class="btn btn-sm btn-primary"><i class="fa fa-search"></i> 搜索</button>
    </form>
</div>-->
#end