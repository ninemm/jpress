#@layout()
#define css()
<link rel="stylesheet" href="#(CPATH)/static/components/bootstrap-table/bootstrap-table.css">
<style>
    blockquote {
        border-left: 5px solid #f39c12;
        background-color: #fff;
    }

    ol {
        padding-inline-start: 10px;
    }
</style>
#end

#define script()
<script src="#(CPATH)/static/components/bootstrap-table/bootstrap-table.js"></script>
<script src="#(CPATH)/static/components/bootstrap-table/bootstrap-table-zh-CN.js"></script>
<script src="https://cdn.bootcss.com/dayjs/1.8.14/dayjs.min.js"></script>

<script>
    let $form = $('#form');
    let $table = $('#_task_table');

    var initParams = function (params) {

        var param = {
            size: params.limit,
            page: params.offset / params.limit + 1
        };
        return param;
    };

    var initFields = function () {
        var fields =
            [
                {field: "checkbox", checkbox: true, width: '2%', class: 'dataItem'},
                {
                    field: "action", title: "操作", width: '12%',
                    formatter: function (value, row, rowIndex) {
                        let url = '#(CPATH)/admin/crawler/task/edit/' + row.id;
                        let html = "";
                        if (row.is_active) {
                            html += '<a href="javascript:;" class="btn btn-xs text-red" title="禁用" onclick="disableTask(\'' + row.id + '\')"><i class="fa fa-ban"></i></a>';
                            if (row.is_start) {
                                html += '<a href="javascript:;" class="btn btn-xs text-orange" title="停止" onclick="stopTask(\'' + row.id + '\')"><i class="fa fa-stop"></i></a>';
                            } else {
                                html += '<a href="javascript:;" class="btn btn-xs text-orange" title="运行" onclick="startTask(\'' + row.id + '\')"><i class="fa fa-play-circle"></i></a>';
                            }
                            html += '<a href="javascript:;" class="btn btn-xs text-orange" title="立即执行" onclick="trigger(\'' + row.id + '\')"><i class="fa fa-play"></i></a>';
                        } else {
                            html += '<a href="javascript:;" class="btn btn-xs text-light-blue" title="启用" onclick="activeTask(\'' + row.id + '\')"><i class="fa fa-circle-o-notch"></i></a>';
                        }

                        html += '<a href="' + url + '" class="btn btn-xs text-green" title="编辑"><i class="fa fa-edit"></i></a> '
                            + '<a href="javascript:void(0);" class="btn btn-xs text-red" title="删除" onclick="doDel(\'' + row.id + '\')"><i class="fa fa-trash"></i></a>';

                        return html;
                    },
                    edit: false
                },
                {field: "task_name", title: "任务名称", width: '12%',
                    formatter: function (value, row, rowIndex) {
                        let url = '#(CPATH)/admin/crawler/task/edit/' + row.id;
                        value = "<strong><a href='" + url + "' title='" + row.task_description + "'>" + value + "</a></strong>";
                        if (!row.is_active) {
                            value = value + '(未启用)';
                        }
                        return value;
                    },
                    edit: false
                },
                /*{field: "task_description", title: "任务描述", align: "left", width: '12%', edit: false},*/
                {field: "cron", title: "cron表达式", width: '8%', edit: false},
                {field: "is_active", title: "状态", width: '8%',
                    formatter: function (value, row, rowIndex) {
                        let html = "";
                        if (value) {
                            html = '<small class="label label-success" title="任务已启用(已运行)">启用</small>';
                        } else {
                            html = '<small class="label label-default" title="任务已启用(未运行)">未启用</small>';
                        }

                        if (row.is_start) {
                            html += ' <small class="label label-success" title="任务已运行(先启用)">运行</small>';
                        } else {
                            html += ' <small class="label label-default" title="任务已停止运行">停止</small>';
                        }

                        return html;
                    },
                    edit: false},
                {field: "is_daemon", title: "守护进程", width: '5%',
                    formatter: function (value, row, rowIndex) {
                        let html = "";
                        if (value) {
                            html = '<small class="label label-success" title="守护进程">是</small>';
                        } else {
                            html = '<small class="label label-default" title="非守护进程">否</small>';
                        }
                        return html;
                    },
                    edit: false},
                {field: "search_type", title: "搜索平台", width: '5%', edit: false},
                {field: "last_execute_time", title: "最近执行时间", align: "center", width: '10%',
                    formatter: function (value, row, rowIndex) {
                        return dayjs(value).format('YYYY-MM-DD HH:mm:ss');
                    },
                    edit: false
                },
                {field: "last_keyword_id", title: "最后处理ID", width: '5%', edit: false},
                {field: "last_page_num", title: "最后执行页码", edit: false},
                {field: "total_num", title: "处理记录总数", edit: false}
            ];
        return fields;
    }

    let options = {
        tableId: '#_task_table',
        url: '#(CPATH)/admin/crawler/task/paginate',
        fields: initFields(),
        queryParams: initParams
    };

    initEditTable(options);

    function doDel(id) {
        let options = {
            msg: '确定删除任务吗?'
            , ids: id
            , okFunction: okDelFunc
        };

        showConfirm(options);
    }

    function okDelFunc(id) {
        ajaxGet("#(CPATH)/admin/crawler/task/doDel?id=" + id, okFunction);
    }

    function trigger(id){
        ajaxGet("#(CPATH)/admin/crawler/task/trigger?id=" + id, function (reuslt) {
            toastr.success(reuslt.message,"操作成功");
        });
    }

    function activeTask(id){
        ajaxGet("#(CPATH)/admin/crawler/task/activeTask?id=" + id);
    }

    function disableTask(id){
        ajaxGet("#(CPATH)/admin/crawler/task/disableTask?id=" + id);
    }

    function stopTask(id){
        ajaxGet("#(CPATH)/admin/crawler/task/stopTask?id=" + id);
    }

    function startTask(id){
        ajaxGet("#(CPATH)/admin/crawler/task/startTask?id=" + id);
    }

    $("#batchDel").click(function () {
        var ids = getSelectedIds();
        if (ids == "") {
            alert('您未选择任何条目');
            return
        }
        ajaxGet("#(CPATH)/admin/crawler/task/doDelByIds?ids=" + ids);
    });

    function okFunction() {
        location.reload();
    }

    function doRefresh() {
        $table.bootstrapTable('refresh', options);
    }
</script>
#end

#define content()
<div class="content-wrapper">

    <section class="content-header">
        <h1>
            任务管理
            <small>Task Manager Items</small>
        </h1>
    </section>

    <section class="content">

        <div class="row">
            <div class="col-xs-12">
                <blockquote style="font-size: 12px;">
                    <ul class="list-unstyled">
                        <li><strong>任务状态：启用、禁止、运行、停用、立即执行</strong></li>
                        <li><strong class="text-orange">启用</strong>: 标明当前任务有效; <strong class="text-orange">禁用</strong>: 启用与禁用状态相对应</li>
                        <li><strong class="text-green">运行</strong>: 运行任务，但必须在<mark>任务启用之后</mark>，才能运行任务; <strong class="text-green">停止</strong>: 停止运行任务</li>
                        <li><strong class="text-blue">立即执行</strong>: 重启服务后，任务状态为启用和运行状态，但任务并没有运行，此时可点击立即执行运行任务</li>
                        <li><i class="fa fa-volume-up text-orange"></i> 任务分为<mark>相关词搜索任务、下拉词搜索任务</mark>两类，通过对不同的搜索引擎进行设置，形成多个任务同时执行。每个任务执行完成之后，又会重头开始执行</li>
                    </ul>
                </blockquote>
            </div>
        </div>

        <div class="row">
            <div class="col-xs-12">
                <div class="box box-primary">
                    <div class="box-header with-border">
                        <div class="row">
                            <div class="col-xs-12">
                                <a href="#(CPATH)/admin/crawler/task/edit" class="btn btn-primary ">
                                    <i class="fa fa-fw fa-plus"></i> 新建
                                </a>
                                <button type="submit" id="batchDel" class="btn btn-default checkAction"> 批量删除</button>
                            </div>
                        </div>
                    </div>
                    <!-- /.box-header -->
                    <div class="box-body">
                        <table class="table table-striped table-hover table-condensed" id="_task_table" style="min-width: 1500px;"></table>
                    </div>
                </div>
                <!-- /.box -->
            </div>
        </div>

    </section>
</div>
#end