#@layout()

#define css()
<style>
    blockquote {
        border-left: 5px solid #f39c12;
        background-color: #fff;
    }

    ol {
        padding-inline-start: 10px;
    }
</style>
#end
	
#define script()
<script>

    function doDel(id) {
        let options = {
            msg: '确定删除任务吗?'
            , ids: id
            , okFunction: okDelFunc
        };

        showConfirm(options);
    }

    function okDelFunc(id) {
        ajaxGet("#(CPATH)/admin/crawler/task/doDel?id=" + id, okFunction);
    }

    function trigger(id){
        ajaxGet("#(CPATH)/admin/crawler/task/trigger?id=" + id, function (reuslt) {
            toastr.success(reuslt.message,"操作成功");
        });
    }

    function activeTask(id){
        ajaxGet("#(CPATH)/admin/crawler/task/activeTask?id=" + id);
    }

    function disableTask(id){
        ajaxGet("#(CPATH)/admin/crawler/task/disableTask?id=" + id);
    }

    function stopTask(id){
        ajaxGet("#(CPATH)/admin/crawler/task/stopTask?id=" + id);
    }

    function startTask(id){
        ajaxGet("#(CPATH)/admin/crawler/task/startTask?id=" + id);
    }

    $("#batchDel").click(function () {
        var ids = getSelectedIds();
        if (ids == "") {
            alert('您未选择任何条目');
            return
        }
        ajaxGet("#(CPATH)/admin/crawler/task/doDelByIds?ids=" + ids);
    });

    function okFunction() {
        location.reload();
    }

</script>
#end

#define content()
<div class="content-wrapper">

    <section class="content-header">
        <h1>
            任务管理
            <small>Task Manager Items</small>
        </h1>
    </section>

    <section class="content">

        <div class="row">
            <div class="col-xs-12">
                <blockquote style="font-size: 12px;">
                    <ul class="list-unstyled">
                        <li><strong>任务状态：启用、禁止、运行、停用、立即执行</strong></li>
                        <li><strong class="text-orange">启用</strong>: 标明当前任务有效; <strong class="text-orange">禁用</strong>: 启用与禁用状态相对应</li>
                        <li><strong class="text-green">运行</strong>: 运行任务，但必须在<mark>任务启用之后</mark>，才能运行任务; <strong class="text-green">停止</strong>: 停止运行任务</li>
                        <li><strong class="text-blue">立即执行</strong>: 重启服务后，任务状态为启用和运行状态，但任务并没有运行，此时可点击立即执行运行任务</li>
                        <li><i class="fa fa-volume-up text-orange"></i> 任务分为<mark>相关词搜索任务、下拉词搜索任务</mark>两类，通过对不同的搜索引擎进行设置，形成多个任务同时执行。每个任务执行完成之后，又会重头开始执行</li>
                    </ul>
                </blockquote>
            </div>
        </div>

        <div class="row">
            <div class="col-xs-12">
                <div class="box box-primary">
                    <div class="box-header with-border">
                        <div class="row">
                            <div class="col-xs-12">
                                <a href="#(CPATH)/admin/crawler/task/edit" class="btn btn-primary ">
                                    <i class="fa fa-fw fa-plus"></i> 新建
                                </a>
                                <button type="submit" id="batchDel" class="btn btn-default checkAction"> 批量删除</button>
                            </div>
                        </div>
                    </div>
                    <!-- /.box-header -->
                    <div class="box-body" style="overflow-x: scroll;">
                        <table class="table table-striped" style="min-width: 1600px;">
                            <thead>
                                <tr>
                                    <th style="width: 10px">
                                        <input name="dataItem" onchange="checkAll(this)" type="checkbox"/>
                                    </th>
                                    <th width="10%">操作</th>
                                    <th width="12%">任务名称</th>
                                    <th width="12%">任务描述</th>
                                    <th width="8%">cron表达式</th>
                                    <th width="8%">状态</th>
                                    <th width="5%">守护进程</th>
                                    <!--<th>分布式任务</th>-->
                                    <th width="5%">搜索平台</th>
                                    <th width="10%">最近执行时间</th>
                                    <th width="8%">最后处理ID</th>
                                    <th>最后执行页码</th>
                                    <th>处理关键词总数</th>
                                </tr>
                            </thead>
                            <tbody>
                            #for(task : page.list)
                            <tr class="jp-actiontr">
                                <td>
                                    <input class="dataItem" type="checkbox" value="#(task.id)" onchange="dataItemChange(this)"/>
                                </td>
                                <td>
                                    #if(task.isActive())
                                    <a href="javascript:;" class="btn btn-xs text-red" title="禁用" onclick="disableTask('#(task.id)')"><i class="fa fa-ban"></i></a>
                                    #if(task.isStart())
                                    <a href="javascript:;" class="btn btn-xs text-orange" title="停止" onclick="stopTask('#(task.id)')"><i class="fa fa-stop"></i></a>
                                    #else
                                    <a href="javascript:;" class="btn btn-xs text-orange" title="运行" onclick="startTask('#(task.id)')"><i class="fa fa-play-circle"></i></a>
                                    #end
                                    <a href="javascript:;" class="btn btn-xs text-orange" title="立即执行" onclick="trigger('#(task.id)')"><i class="fa fa-play"></i></a>
                                    #else
                                    <a href="javascript:;" class="btn btn-xs text-light-blue" title="启用" onclick="activeTask('#(task.id)')"><i class="fa fa-circle-o-notch"></i></a>
                                    #end
                                    <a href="#(CPATH)/admin/crawler/task/edit/#(task.id)" class="btn btn-xs text-green" title="编辑"><i class="fa fa-edit"></i></a>
                                    <a href="javascript:;" class="btn btn-xs text-red" title="删除" onclick="doDel('#(task.id)')"><i class="fa fa-trash"></i></a>
                                </td>
                                <td>
                                    <strong>
                                        <a href="#(CPATH)/admin/crawler/task/edit?id=#(task.id)"> #(task.task_name ??) </a>
                                        #if(!task.isActive())
                                        (未启用)
                                        #end
                                    </strong>
                                    <!--<div class="jp-actionblock">
                                        <div class="jp-actionitem">

                                        </div>
                                    </div>-->
                                </td>
                                <td>#(task.task_description)</td>
                                <!--<td>#(task.task_class)</td>-->
                                <td>#(task.cron)</td>
                                <td>
                                    #if(task.isActive())
                                    <small class="label label-success" title="任务已启用(未运行)">启用</small>
                                    #else
                                    <small class="label label-default" title="任务未启用(未运行)">未启用</small>
                                    #end

                                    #if(task.isStart())
                                    <small class="label label-success" title="任务已运行(先启用)">运行</small>
                                    #else
                                    <small class="label label-default" title="任务已停止运行">停止</small>
                                    #end
                                </td>
                                <td>
                                    #if(task.isDaemon())
                                    <small class="label label-success" title="守护进程">是</small>
                                    #else
                                    <small class="label label-default" title="非守护进程">否</small>
                                    #end
                                </td>
                                <!--<td>
                                    #if(task.isDistributed())
                                    <small class="label label-success" title="分布式任务">是</small>
                                    #else
                                    <small class="label label-default" title="非分布式任务">否</small>
                                    #end
                                </td>-->
                                <td>#(task.search_type)</td>
                                <td>#date(task.last_execute_time, 'yyyy-MM-dd HH:mm:ss')</td>
                                <td>#(task.last_keyword_id)</td>
                                <td>#(task.last_page_num)</td>
                                <td>#(task.total_num)</td>
                            </tr>
                            #end
                            </tbody>
                        </table>
                    </div>
                    <!-- /.box-body -->
                    <div class="box-footer">
                        <div class="row">
                            <div class="col-sm-12">
                            	 #@_paginate()
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /.box -->
            </div>
        </div>

    </section>
</div>
#end